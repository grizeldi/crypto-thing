<html>

<head>
    <title>Crypto Thing</title>
    <script src="/jquery.js"></script>
    <script src="/web3.min.js"></script>

    <script>
        let web3 = new Web3("ws://localhost:8546");
        let metamaskWeb3;
        if (window.ethereum) {
            metamaskWeb3 = new Web3(window.ethereum);
        }
        
        async function fetchIDs() {
            await window.ethereum.send('eth_requestAccounts');
            const config = await $.ajax("/chainconfig.json");

            ethereum.request({ method: 'eth_accounts' })
                .then(async (accounts) => {
                    // We're using both providers because metamask's implementation of events doesn't work 90% of the time
                    const idContractMetamask = new metamaskWeb3.eth.Contract(config.idOracleAbi, config.idOracleAddress);
                    const idContract = new web3.eth.Contract(config.idOracleAbi, config.idOracleAddress);
                    idContract.events.DataAvailable({}, async (error, event) => {
                        if (event.returnValues._forUser.toLowerCase() === accounts[0].toLowerCase()) {
                            const data = await idContractMetamask.methods.readData().call({ from: accounts[0] });
                            // Ok, here we (theoretically) have the user data IDs
                            console.log(data);
                            //TODO display the data in the DOM
                            $('#button1').html(data[0]);
                        }
                    });
                    await idContractMetamask.methods.request().send({ from: accounts[0] });
                })
                .catch((error) => {
                    console.log(error);
                    window.alert("There was a problem contacting the blockchain for the user IDs");
                });

        }

        $(document).ready(async () => {
            //Load the available content
            $("#button1").on("click", async (event) => {
                console.log("button");
                const config = await $.ajax("/chainconfig.json");
    
                ethereum.request({ method: 'eth_accounts' })
                    .then(async (accounts) => {
                        const dataContractMetamask = new metamaskWeb3.eth.Contract(config.dataOracleAbi, config.dataOracleAddress);
                        const dataContract = new web3.eth.Contract(config.dataOracleAbi, config.dataOracleAddress);
                        dataContract.events.DataAvailable({}, async (error, event) => {
                            if (event.returnValues._forUser.toLowerCase() === accounts[0].toLowerCase()) {
                                const data = await dataContractMetamask.methods.readData().call({ from: accounts[0] });
                                //TODO display the data in the DOM
                                window.alert(data);
                            }
                        });
                        await dataContractMetamask.methods.request(event.target.innerHTML).send({ from: accounts[0] }); //change the data ID from innerHTML to something more useful
                    })
                    .catch((error) => {
                        console.log(error);
                        window.alert("There was a problem contacting the blockchain for the data.");
                    });
            });

            await fetchIDs();
        });

    </script>
</head>

<body>
    <p>Testing.</p>
    <button type="button" id="button1">Data Button</button>
</body>

</html>